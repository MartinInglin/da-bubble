<!-- Main content of the document -->
<main id="mainContent">

  <!-- Header section with channel name and contact information -->
 <header *ngIf="!channelSelected && !chatSelected" class="newMessage" [formGroup]="form">
  <span>Neue Nachricht</span>
  <input type="text" formControlName="recipient" placeholder="An: #channel, oder @jemand oder E-mail Adresse" />
  <div *ngIf="searchResults && searchResults.length">
    <ul>
      <li *ngFor="let result of searchResults" (click)="selectRecipient(result)">
        {{ result.name }} ({{ result.id ? "Channel" : "Direct Message" }})
      </li>
    </ul>
  </div>
</header>

  <div class="height-65vh" *ngIf="channelSelected">
    <header>
      <div (click)="openChannelInfoDialog(selectedChannel.id)" class="channelName">
        {{ selectedChannel.name }}
      </div>

      <div class="members-and-button">
        <div class="channelMembers" *ngIf="channelSelected" (click)="openMembersDialog(selectedChannel.id)">
          <!-- Profile pictures of channel members which are part of the group -->
          <ng-container *ngFor="let user of selectedChannel.users">
            <img src="{{ user.avatar }}" alt="" />
          </ng-container>
          <p>{{ userCount }}</p>
        </div>
        <button (click)="openAddUserToChannelDialog(selectedChannel.id)"><img src="assets/images/icons/add_member.svg"></button>
      </div>
    </header>

    <!-- Message Content  -->

    <div class="message-content">
      @if (selectedChannel.posts.length > 0) {
      <div *ngFor="let post of selectedChannel.posts; let i = index">
        <!-- Date line for messages -->
        <div class="dateLine">
          <div class="Line">
            <span>{{ formatDate(post.timestamp) }}</span>
          </div>
        </div>

        <!-- Post -->
        <app-post [post]="post" [currentUserId]="currentUser.id" [isChannel]="true" [selectedChannel]="selectedChannel" (toggleThread)="openThread()"> </app-post>

        <div class="message-details">
          <!-- Message actions and time details -->
          <a>Antworten</a>
          <span>Letzte Antwort:{{
            formatDateTime(selectedChannel.posts[i].timestamp)
            }}
          </span>
        </div>
      </div>
      }

      <!-- Placeholder if no post is in channel -->
      @if (selectedChannel.posts.length === 0) {
      <div class="placeholderContainer" *ngIf="channelSelected">
        <img src="{{ selectedChannel.name }}" alt="" />
        <h3>{{ selectedChannel.description }}</h3>
        <div>
          <span>Schreib etwas in die Gruppe
            <a> {{ selectedChannel.name }}</a> damit andere darauf
            reagieren.</span>
        </div>
      </div>
      }
    </div>

    <!-- Input Feld am unteren Rand des Containers -->
    <div class="inputContent" *ngIf="channelSelected">
      <div class="textArea">
        <textarea name="" id="message-textarea" placeholder="Nachricht an #{{ selectedChannel.name }}" [(ngModel)]="message"></textarea>

        @if (files.length > 0) {
        <div class="documents-container">
          @for (file of files; track file; let index = $index) {
          <div class="document" (click)="removeFile(index)">
            {{ file.name }}
          </div>
          }
        </div>
        }
        <div class="icons">
          <div class="buttons">
            <a class="addIcon" (click)="openFileDialog()">
              <img src="assets/images/icons/add_icon.svg" alt="" />
            </a>
            <input type="file" #fileInput style="display: none" (change)="onFileSelected($event)" />

            <div class="seperator"></div>

            <!-- Liste f端r Emojis -->
            <div class="link-emojis">
              <button mat-button [matMenuTriggerFor]="aboveMenu">
                <img src="assets/images/icons/smiley-Icon.svg" alt="" />
              </button>
              <mat-menu #aboveMenu="matMenu" yPosition="above">
                <div class="emoji-container">
                  <span *ngFor="let emoji of emojis" class="emoji" mat-menu-item (click)="addEmojiToMessage(emoji)">{{ emoji }}</span>
                </div>
              </mat-menu>
              <!-- Liste f端r Verlinkungen von Kontakten -->
              <button mat-button [matMenuTriggerFor]="contactLinks">
                <img src="assets/images/icons/link_icon.svg" alt="" />
              </button>
              <mat-menu #contactLinks="matMenu" yPosition="above">
                <div class="link-container">
                  <table class="links">
                    <tr *ngFor="let user of allUsers">
                      <td (click)="linkContactInMessage(user.name)">
                        <img [src]="user.avatar" alt="Profilbild" />
                        <span>{{ user.name }}</span>
                      </td>
                    </tr>
                  </table>
                </div>
              </mat-menu>
            </div>
          </div>

          <a (click)="sendMessage()">
            <img src="assets/images/icons/send_icon.svg" alt="" />
          </a>
        </div>
      </div>
    </div>
  </div>

  <div class="height-65vh" *ngIf="chatSelected">
    <!-- Header section with channel name and contact information -->
    <header *ngIf="chatSelected">
      <div class="channelName" *ngIf="
          directMessage && directMessage.users && directMessage.users.length > 0
        ">
        <div class="avatarName">
          <img src="{{ directMessage.users[0].avatar }}" alt="" />
          {{ directMessage.users[0].name }}
        </div>
      </div>
    </header>

    <!-- Message Content  -->

    <div class="message-content">
      <!-- Date line for messages -->
      @if (directMessage && directMessage.posts && directMessage.posts.length >
      0 && directMessage.users.length > 0) {
      <div class="dateLine">
        <div class="Line">
          <span>{{ formatDate(selectedChannel.posts[0].timestamp) }}</span>
        </div>
      </div>
      <!--Message Loop -->
      <div class="message">
        <div class="message-container">
          <!-- Profile picture of the message author -->
          <img [src]="directMessage.users[0].avatar" alt="" />
          <!-- Message box -->
          <div class="message-box">
            <div class="message-name">
              <!-- Name of the message author -->
              <span>{{ directMessage.users[0].name }}</span>
            </div>
            <div class="message-text">
              <!-- Text of the message -->
              <span>{{ directMessage.posts }}</span>
            </div>

            <div class="message-details">
              <!-- Message actions and time details -->
              <a>Antworten</a>
              <span>Letzte Antwort:{{
                formatDateTime(selectedChannel.posts[0].timestamp)
                }}
              </span>
            </div>
          </div>
        </div>
      </div>

      }

      <!-- Placeholder if no message is in channel -->

      <div class="placeholderContainer" *ngIf="
          chatSelected && directMessage && directMessage.posts.length === 0
        ">
        <div class="messageAvatarName">
          <img src="{{ directMessage.users[0].avatar }}" alt="" />
          <span>{{ directMessage.users[0].name }}</span>
        </div>

        <div>
          <p>
            Diese Unterhaltun findet nur zwischen
            {{ directMessage.users[0].name }} und dir statt.
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Input Feld am unteren Rand des Containers -->
  <div class="inputContent" id="inputDirectMessage" *ngIf="chatSelected">
    <div class="textArea">
      <textarea name="" id="message-textarea" placeholder="Nachricht an #Entwicklerteam" [(ngModel)]="message"></textarea>

      <div class="icons">
        <div class="buttons">
          <a [matMenuTriggerFor]="attachment" class="addIcon">
            <img src="assets/images/icons/add_icon.svg" alt="" />
          </a>
          <mat-menu #attachment="matMenu" yPosition="above">
            <div class="attachment-container"></div>
          </mat-menu>

          <div class="seperator"></div>

          <!-- Liste f端r Emojis -->
          <div class="link-emojis">
            <button mat-button [matMenuTriggerFor]="aboveMenu">
              <img src="assets/images/icons/smiley-Icon.svg" alt="" />
            </button>
            <mat-menu #aboveMenu="matMenu" yPosition="above">
              <div class="emoji-container">
                <span *ngFor="let emoji of emojis" (click)="addEmojiToMessage(emoji)" class="emoji" mat-menu-item>{{ emoji }}</span>
              </div>
            </mat-menu>
            <!-- Liste f端r Verlinkungen von Kontakten -->
            <button mat-button [matMenuTriggerFor]="contactLinks">
              <img src="assets/images/icons/link_icon.svg" alt="" />
            </button>
            <mat-menu #contactLinks="matMenu" yPosition="above">
              <div class="link-container">
                <table class="links">
                  <tr *ngFor="let user of allUsers">
                    <td (click)="linkContactInMessage(user.name)">
                      <img [src]="user.avatar" alt="Profilbild" />
                      <span>{{ user.name }}</span>
                    </td>
                  </tr>
                </table>
              </div>
            </mat-menu>
          </div>
        </div>

        <a (click)="sendMessageToContact()">
          <img src="./../../../../assets/images/icons/send_icon.svg" alt="" />
        </a>
      </div>
    </div>
  </div>
</main>