<!-- Main content of the document -->
<main id="mainContent">
  <!-- Channel -->

  <!-- Header section with channel name and contact information -->
  <header
    *ngIf="!channelSelected && !chatSelected"
    class="newMessage"
    [formGroup]="form"
  >
    <span>Neue Nachricht</span>
    <input
      type="text"
      formControlName="recipient"
      placeholder="An: #channel, oder @jemand oder E-mail Adresse"
    />
    <div *ngIf="searchResults$ | async as results">
      <h2>Search Results</h2>
      <ul>
        <li *ngFor="let result of results" (click)="selectRecipient(result)">
          {{ result.id ? result.id : result.name }} ({{
            result.id ? "Channel" : "Direct Message"
          }})
        </li>
      </ul>
    </div>
  </header>

  <div class="height-65vh" *ngIf="channelSelected">
    <header>
      <div
        (click)="openChannelInfoDialog(selectedChannel.id)"
        class="channelName"
      >
        {{ selectedChannel.name }}
      </div>

      <div
        class="channelMembers"
        *ngIf="channelSelected"
        (click)="openMembersDialog(selectedChannel.id)"
      >
        <!-- Profile pictures of channel members which are part of the group -->
        <ng-container *ngFor="let user of selectedChannel.users">
          <img src="{{ user.avatar }}" alt="" />
        </ng-container>
      </div>
    </header>

    <!-- Message Content  -->
    <div class="message-content">
      @if (selectedChannel.posts.length > 0) {
      <div *ngFor="let post of selectedChannel.posts">
        <!-- Date line for messages -->
        <div class="dateLine">
          <div class="Line">
            <span>{{ formatDate(post.timestamp) }}</span>
          </div>
        </div>

        <!-- Post -->
        <app-post
          [post]="post"
          [currentUserId]="currentUser.id"
          [isChannel]="true"
          [selectedChannel]="selectedChannel"
          (click)="openThread(post)"
        >
          <div class="message-details">
            <!-- Message actions and time details -->
            <a>Antworten</a>
            <span>Letzte Antwort:{{ formatDateTime(post.timestamp) }} </span>
          </div>
        </app-post>
      </div>
      }

      <!-- Placeholder if no post is in channel -->
      @if (selectedChannel.posts.length === 0) {
      <div class="placeholderContainer" *ngIf="channelSelected">
        <img src="{{ selectedChannel.name }}" alt="" />
        <h3>{{ selectedChannel.description }}</h3>
        <div>
          <span
            >Schreib etwas in die Gruppe
            <a> {{ selectedChannel.name }}</a> damit andere darauf
            reagieren.</span
          >
        </div>
      </div>
      }
    </div>

    <!-- Input Feld am unteren Rand des Containers -->
    <div class="inputContent" *ngIf="channelSelected">
      <div class="textArea">
        <textarea
          name=""
          id="message-textarea"
          placeholder="Nachricht an #{{ selectedChannel.name }}"
          [(ngModel)]="message"
        ></textarea>

        @if (files.length > 0) {
        <div class="documents-container">
          @for (file of files; track file; let index = $index) {
          <div class="document" (click)="removeFile(index)">
            {{ file.name }}
          </div>
          }
        </div>
        }
        <div class="icons">
          <div class="buttons">
            <a class="addIcon" (click)="openFileDialog()">
              <img src="assets/images/icons/add_icon.svg" alt="" />
            </a>
            <input
              type="file"
              #fileInput
              style="display: none"
              (change)="onFileSelected($event)"
            />

            <div class="seperator"></div>

            <!-- Liste f端r Emojis -->
            <div class="link-emojis">
              <button mat-button [matMenuTriggerFor]="aboveMenu">
                <img src="assets/images/icons/smiley-Icon.svg" alt="" />
              </button>
              <mat-menu #aboveMenu="matMenu" yPosition="above">
                <div class="emoji-container">
                  <span
                    *ngFor="let emoji of emojis"
                    class="emoji"
                    mat-menu-item
                    (click)="addEmojiToMessage(emoji)"
                    >{{ emoji }}</span
                  >
                </div>
              </mat-menu>
              <!-- Liste f端r Verlinkungen von Kontakten -->
              <button mat-button [matMenuTriggerFor]="contactLinks">
                <img src="assets/images/icons/link_icon.svg" alt="" />
              </button>
              <mat-menu #contactLinks="matMenu" yPosition="above">
                <div class="link-container">
                  <table class="links">
                    <tr *ngFor="let user of allUsers">
                      <td (click)="linkContactInMessage(user.name)">
                        <img [src]="user.avatar" alt="Profilbild" />
                        <span>{{ user.name }}</span>
                      </td>
                    </tr>
                  </table>
                </div>
              </mat-menu>
            </div>
          </div>

          <a (click)="sendMessage()">
            <img src="assets/images/icons/send_icon.svg" alt="" />
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Direct Message -->

  <div class="height-65vh" *ngIf="chatSelected">
    <!-- Header section with channel name and contact information -->
    <header *ngIf="chatSelected">
      <div class="channelName" *ngIf="selectedDirectMessage.users.length > 0">
        <div class="avatarName">
          <img src="{{ otherUserDirectMessage.avatar }}" alt="" />
          {{ otherUserDirectMessage.name }}
        </div>
      </div>
    </header>

    <!-- Message Content  -->

    <div class="message-content">
      <!-- Date line for messages -->
      @if (selectedDirectMessage.posts.length > 0 &&
      selectedDirectMessage.users.length > 0) {
      <div *ngFor="let post of selectedDirectMessage.posts">
        <!-- Date line for messages -->
        <div class="dateLine">
          <div class="Line">
            <span>{{ formatDate(post.timestamp) }}</span>
          </div>
        </div>

        <!-- Post -->
        <app-post
          [post]="post"
          [currentUserId]="currentUser.id"
          [isChannel]="false"
          [selectedChannel]="selectedChannel"
        >
        </app-post>
      </div>

      }

      <!-- Placeholder if no message is in channel -->

      <div
        class="placeholderContainer"
        *ngIf="
          chatSelected &&
          selectedDirectMessage &&
          selectedDirectMessage.posts.length === 0
        "
      >
        <div class="messageAvatarName">
          <img src="{{ otherUserDirectMessage.avatar }}" alt="" />
          <span>{{ otherUserDirectMessage.name }}</span>
        </div>

        <div>
          <p>
            Diese Unterhaltun findet nur zwischen
            {{ otherUserDirectMessage.name }} und dir statt.
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Input Feld am unteren Rand des Containers -->
  <div class="inputContent" id="inputDirectMessage" *ngIf="chatSelected">
    <div class="textArea">
      <textarea
        name=""
        id="message-textarea"
        placeholder="Nachricht an #Entwicklerteam"
        [(ngModel)]="message"
      ></textarea>

      <div class="icons">
        <div class="buttons">
          <a [matMenuTriggerFor]="attachment" class="addIcon">
            <img src="assets/images/icons/add_icon.svg" alt="" />
          </a>
          <mat-menu #attachment="matMenu" yPosition="above">
            <div class="attachment-container"></div>
          </mat-menu>

          <div class="seperator"></div>

          <!-- Liste f端r Emojis -->
          <div class="link-emojis">
            <button mat-button [matMenuTriggerFor]="aboveMenu">
              <img src="assets/images/icons/smiley-Icon.svg" alt="" />
            </button>
            <mat-menu #aboveMenu="matMenu" yPosition="above">
              <div class="emoji-container">
                <span
                  *ngFor="let emoji of emojis"
                  (click)="addEmojiToMessage(emoji)"
                  class="emoji"
                  mat-menu-item
                  >{{ emoji }}</span
                >
              </div>
            </mat-menu>
            <!-- Liste f端r Verlinkungen von Kontakten -->
            <button mat-button [matMenuTriggerFor]="contactLinks">
              <img src="assets/images/icons/link_icon.svg" alt="" />
            </button>
            <mat-menu #contactLinks="matMenu" yPosition="above">
              <div class="link-container">
                <table class="links">
                  <tr *ngFor="let user of allUsers">
                    <td (click)="linkContactInMessage(user.name)">
                      <img [src]="user.avatar" alt="Profilbild" />
                      <span>{{ user.name }}</span>
                    </td>
                  </tr>
                </table>
              </div>
            </mat-menu>
          </div>
        </div>

        <a (click)="sendMessageToContact()">
          <img src="assets/images/icons/send_icon.svg" alt="" />
        </a>
      </div>
    </div>
  </div>
</main>
